<!-- Create this file as src/public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Training Assistant</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .chat-container { max-width: 800px; margin: 0 auto; }
        .messages { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 20px; margin-bottom: 20px; }
        .message { margin-bottom: 15px; padding: 15px; border-radius: 8px; line-height: 1.5; }
        .user { background: #e3f2fd; margin-left: 50px; }
        .assistant { background: #f5f5f5; margin-right: 50px; }
        .input-area { display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; font-size: 16px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }

        /* Style for formatted messages */
        .message strong {
            font-weight: bold;
            color: #2c3e50;
        }

        .message em {
            font-style: italic;
            color: #7f8c8d;
        }

        .message ul, .message ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message li {
            margin: 5px 0;
        }

        .message br {
            margin-bottom: 8px;
            display: block;
            content: "";
        }
    </style>
</head>
<body>
<div class="chat-container">
    <h1>ü§ñ AI Training Assistant</h1>

    <!-- User Controls Section -->
    <div class="user-controls">
        <div>
            <label><strong>User ID: </strong></label>
            <input type="text" id="userId" placeholder="Enter user ID" style="width: 200px;" />
            <button onclick="initializeChat()">Initialize Chat</button>
            <button id="clearHistoryBtn" class="clear-btn" onclick="clearChatHistory()" disabled>üóëÔ∏è Clear Chat History</button>
        </div>
        <div id="status" class="status"></div>
    </div>

    <!-- Chat Messages -->
    <div id="messages" class="messages"></div>

    <!-- Message Input -->
    <div class="input-area">
        <input type="text" id="messageInput" placeholder="Ask about trainings or projects..." />
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:3000/api';
    let currentUserId = '';
    const sessionId = 'web-session';

    async function initializeChat() {
        const userId = document.getElementById('userId').value;
        if (!userId) {
            showStatus('Please enter a user ID', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/users/${userId}/chat/init`, {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                currentUserId = userId;
                // Enable clear button
                document.getElementById('clearHistoryBtn').disabled = false;
                // Clear previous messages and show welcome
                document.getElementById('messages').innerHTML = '';
                addMessage('assistant', data.message);
                showStatus(`Chat initialized for user: ${data.userProfile.name}`, 'success');
            } else {
                showStatus('Error: ' + data.error, 'error');
            }
        } catch (error) {
            showStatus('Failed to initialize chat: ' + error.message, 'error');
        }
    }

    async function clearChatHistory() {
        if (!currentUserId) {
            showStatus('Please initialize chat first', 'error');
            return;
        }

        if (!confirm('Are you sure you want to clear all chat history? This action cannot be undone.')) {
            return;
        }

        const clearBtn = document.getElementById('clearHistoryBtn');
        const originalText = clearBtn.textContent;

        clearBtn.disabled = true;
        clearBtn.textContent = 'üîÑ Clearing...';

        try {
            const response = await fetch(`${API_BASE}/users/${currentUserId}/chat/history`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sessionId: sessionId
                })
            });
            const data = await response.json();

            if (data.success) {
                // Clear the chat messages display
                document.getElementById('messages').innerHTML = '';
                showStatus('Chat history cleared successfully!', 'success');

                // Optionally re-initialize with welcome message
                setTimeout(() => {
                    initializeChat(); // This will fetch a new welcome message
                }, 500);

            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showStatus('Failed to clear chat history: ' + error.message, 'error');
        } finally {
            clearBtn.disabled = false;
            clearBtn.textContent = originalText;
        }
    }

    async function sendMessage() {
        const message = document.getElementById('messageInput').value;
        if (!message || !currentUserId) {
            showStatus('Please initialize chat and enter a message', 'error');
            return;
        }

        addMessage('user', message);
        document.getElementById('messageInput').value = '';

        try {
            const response = await fetch(`${API_BASE}/users/${currentUserId}/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    sessionId: sessionId
                })
            });
            const data = await response.json();

            if (data.success) {
                addMessage('assistant', data.aiResponse);
            } else {
                addMessage('assistant', 'Error: ' + data.error);
            }
        } catch (error) {
            addMessage('assistant', 'Failed to send message: ' + error.message);
        }
    }

    function addMessage(role, content) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        messageDiv.textContent = content;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showStatus(message, type) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
        statusDiv.style.display = 'block';

        // Auto-hide success messages after 3 seconds
        if (type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    }

    // Allow sending with Enter key
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Allow initializing with Enter key in user ID field
    document.getElementById('userId').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            initializeChat();
        }
    });
    // Simple markdown to HTML converter
    function markdownToHtml(text) {
        return text
            // Convert **bold** to <strong>bold</strong>
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Convert *italic* to <em>italic</em>
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // Convert bullet points to HTML lists
            .replace(/^\s*[-*]\s+(.+)$/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
            // Convert line breaks to <br>
            .replace(/\n/g, '<br>')
            // Convert numbered lists
            .replace(/^\s*(\d+)\.\s+(.+)$/gm, '<li>$2</li>')
            .replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
    }

    // Update your addMessage function to use HTML
    function addMessage(role, content) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        // Convert markdown to HTML and set as innerHTML
        messageDiv.innerHTML = markdownToHtml(content);

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>